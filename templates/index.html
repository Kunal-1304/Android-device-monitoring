{% extends "base.html" %}

{% block title %}Dashboard - Android Monitor Pro{% endblock %}

{% block head_extra %}
<style>
    .dashboard-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        border-left: 4px solid #007bff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stat-card h3 {
        margin: 0 0 15px 0;
        color: #333;
        font-size: 1.2em;
    }
    
    .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
        margin: 10px 0;
    }
    
    .stat-details {
        font-size: 0.9em;
        color: #666;
        margin: 5px 0;
    }
    
    .progress-bar {
        width: 100%;
        height: 20px;
        background-color: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
    }
    
    .progress-fill {
        height: 100%;
        background-color: #28a745;
        transition: width 0.3s ease;
    }
    
    .progress-fill.warning {
        background-color: #ffc107;
    }
    
    .progress-fill.danger {
        background-color: #dc3545;
    }
    
    .alerts-section {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .no-data {
        text-align: center;
        color: #666;
        font-style: italic;
        padding: 40px;
    }
    
    .last-updated {
        text-align: right;
        font-size: 0.8em;
        color: #666;
        margin-bottom: 20px;
    }
    
    .device-info {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
    }
    
    .battery-info {
        background: #f3e5f5;
        border-left: 4px solid #9c27b0;
    }
    
    .ram-info {
        background: #e8f5e8;
        border-left: 4px solid #4caf50;
    }
    
    .storage-info {
        background: #fff3e0;
        border-left: 4px solid #ff9800;
    }
    
    .location-info {
        background: #fce4ec;
        border-left: 4px solid #e91e63;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1>üì± Android Monitor Pro - Dashboard</h1>
    <p class="subtitle">Real-time system analytics</p>
    
    <div class="last-updated" id="lastUpdated">
        <!-- Last updated time will be shown here -->
    </div>
    
    <div class="stats-grid" id="statsGrid">
        <!-- Device Info Card -->
        <div class="stat-card device-info">
            <h3>üì± Device Information</h3>
            <div class="stat-details" id="deviceName">Device: Loading...</div>
            <div class="stat-details" id="deviceVersion">Android Version: Loading...</div>
            <div class="stat-details" id="deviceIP">IP Address: Loading...</div>
        </div>
        
        <!-- Battery Card -->
        <div class="stat-card battery-info">
            <h3>üîã Battery Status</h3>
            <div class="stat-value" id="batteryPercentage">--%</div>
            <div class="progress-bar">
                <div class="progress-fill" id="batteryProgress"></div>
            </div>
            <div class="stat-details" id="batteryStatus">Status: Loading...</div>
            <div class="stat-details" id="batteryTemp">Temperature: Loading...</div>
            <div class="stat-details" id="batteryHealth">Health: Loading...</div>
        </div>
        
        <!-- RAM Card -->
        <div class="stat-card ram-info">
            <h3>üß† RAM Usage</h3>
            <div class="stat-value" id="ramUsage">--%</div>
            <div class="progress-bar">
                <div class="progress-fill" id="ramProgress"></div>
            </div>
            <div class="stat-details" id="ramTotal">Total: Loading...</div>
            <div class="stat-details" id="ramAvailable">Available: Loading...</div>
        </div>
        
        <!-- Storage Card -->
        <div class="stat-card storage-info">
            <h3>üíæ Storage Usage</h3>
            <div class="stat-value" id="storageUsage">--%</div>
            <div class="progress-bar">
                <div class="progress-fill" id="storageProgress"></div>
            </div>
            <div class="stat-details" id="storageTotal">Total: Loading...</div>
            <div class="stat-details" id="storageFree">Free: Loading...</div>
        </div>
        
        <!-- Location Card -->
        <div class="stat-card location-info">
            <h3>üìç Location</h3>
            <div class="stat-details" id="locationLat">Latitude: Loading...</div>
            <div class="stat-details" id="locationLng">Longitude: Loading...</div>
            <div class="stat-details" id="locationAccuracy">Accuracy: Loading...</div>
        </div>
    </div>
    
    <!-- Alerts Section -->
    <div class="alerts-section" id="alertsSection" style="display: none;">
        <h3>‚ö†Ô∏è Active Alerts</h3>
        <div id="alertsList">
            <!-- Alerts will be populated here -->
        </div>
    </div>
    
    <!-- No Data Message -->
    <div class="no-data" id="noDataMessage">
        <h3>üì° Waiting for device data...</h3>
        <p>Make sure your Android device is connected and sending data to the server.</p>
    </div>
</div>

<script>
let updateInterval;

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatTemperature(temp) {
    return temp ? `${temp}¬∞C` : 'N/A';
}

function getProgressClass(percentage) {
    if (percentage >= 90) return 'danger';
    if (percentage >= 70) return 'warning';
    return '';
}

function updateDashboard() {
    fetch('/data')
        .then(response => response.json())
        .then(result => {
            const data = result.data;
            const alerts = result.alerts || [];
            
            if (Object.keys(data).length === 0) {
                document.getElementById('noDataMessage').style.display = 'block';
                document.getElementById('statsGrid').style.display = 'none';
                return;
            }
            
            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('statsGrid').style.display = 'grid';
            
            // Update last updated time
            if (data.last_updated) {
                const lastUpdated = new Date(data.last_updated);
                document.getElementById('lastUpdated').textContent = 
                    `Last updated: ${lastUpdated.toLocaleString()}`;
            }
            
            // Update Device Info
            if (data.device_info) {
                document.getElementById('deviceName').textContent = 
                    `Device: ${data.device_info.device_name || 'Unknown'}`;
                document.getElementById('deviceVersion').textContent = 
                    `Android Version: ${data.device_info.android_version || 'Unknown'}`;
            }
            if (data.ip) {
                document.getElementById('deviceIP').textContent = `IP Address: ${data.ip}`;
            }
            
            // Update Battery Info
            if (data.battery) {
                const battery = data.battery;
                const percentage = battery.percentage || 0;
                
                document.getElementById('batteryPercentage').textContent = `${percentage}%`;
                document.getElementById('batteryProgress').style.width = `${percentage}%`;
                document.getElementById('batteryProgress').className = 
                    `progress-fill ${getProgressClass(100 - percentage)}`;
                
                document.getElementById('batteryStatus').textContent = 
                    `Status: ${battery.status || 'Unknown'}`;
                document.getElementById('batteryTemp').textContent = 
                    `Temperature: ${formatTemperature(battery.temperature)}`;
                document.getElementById('batteryHealth').textContent = 
                    `Health: ${battery.health || 'Unknown'}`;
            }
            
            // Update RAM Info
            if (data.ram) {
                const ram = data.ram;
                const usedPercent = ram.used_percent || 0;
                
                document.getElementById('ramUsage').textContent = `${usedPercent.toFixed(1)}%`;
                document.getElementById('ramProgress').style.width = `${usedPercent}%`;
                document.getElementById('ramProgress').className = 
                    `progress-fill ${getProgressClass(usedPercent)}`;
                
                document.getElementById('ramTotal').textContent = 
                    `Total: ${ram.total_gb ? ram.total_gb.toFixed(2) + ' GB' : 'N/A'}`;
                document.getElementById('ramAvailable').textContent = 
                    `Available: ${ram.avail_gb ? ram.avail_gb.toFixed(2) + ' GB' : 'N/A'}`;
            }
            
            // Update Storage Info
            if (data.full_storage) {
                const storage = data.full_storage;
                const usedPercent = storage.used_percent || 0;
                
                document.getElementById('storageUsage').textContent = `${usedPercent.toFixed(1)}%`;
                document.getElementById('storageProgress').style.width = `${usedPercent}%`;
                document.getElementById('storageProgress').className = 
                    `progress-fill ${getProgressClass(usedPercent)}`;
                
                document.getElementById('storageTotal').textContent = 
                    `Total: ${storage.total_gb ? storage.total_gb.toFixed(2) + ' GB' : 'N/A'}`;
                document.getElementById('storageFree').textContent = 
                    `Free: ${storage.free_gb ? storage.free_gb.toFixed(2) + ' GB' : 'N/A'}`;
            }
            
            // Update Location Info
            if (data.location) {
                const location = data.location;
                document.getElementById('locationLat').textContent = 
                    `Latitude: ${location.latitude ? location.latitude.toFixed(6) : 'N/A'}`;
                document.getElementById('locationLng').textContent = 
                    `Longitude: ${location.longitude ? location.longitude.toFixed(6) : 'N/A'}`;
                document.getElementById('locationAccuracy').textContent = 
                    `Accuracy: ${location.accuracy ? location.accuracy + ' meters' : 'N/A'}`;
            }
            
            // Update Alerts
            if (alerts.length > 0) {
                document.getElementById('alertsSection').style.display = 'block';
                const alertsList = document.getElementById('alertsList');
                alertsList.innerHTML = alerts.map(alert => 
                    `<div style="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.5); border-radius: 4px;">${alert}</div>`
                ).join('');
            } else {
                document.getElementById('alertsSection').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error fetching data:', error);
            document.getElementById('noDataMessage').style.display = 'block';
            document.getElementById('statsGrid').style.display = 'none';
        });
}

// Initial load
updateDashboard();

// Auto-refresh every 5 seconds
updateInterval = setInterval(updateDashboard, 5000);

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (updateInterval) {
        clearInterval(updateInterval);
    }
});
</script>
{% endblock %}